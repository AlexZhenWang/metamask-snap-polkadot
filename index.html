<!doctype html>

<html>

  </head>
    <title>Hello Plugins!</title>
  </head>

  <body>
    <img src="https://blog.coinfabrik.com/wp-content/uploads/2019/04/polkadot-substrate.png" height="60"/>
    <h2>Polkadot metamask snap</h2>
    <details>
      <summary>Instructions</summary>
      <ul>
        <li>First, click "Connect polkadot plugin". Then, try out the other buttons!</li>
        <li>Please note that:</li>
        <ul>
          <li>
            The Snap <b>package.json</b> must be located in located in the server root directory
          </li>
          <li>
            The Snap bundle must be hosted at the location specified by <b>package.json:web3Wallet:bundle:url</b>
          </li>
        </ul>
      </ul>
    </details>
    <br/>
    <div style="margin-bottom: 10px">
      <button class="connect-snap">Connect polkadot snap</button>
    </div>
    <div>
      <label>Public key:</label>
      <div class="publicKey"></div>
      <label style="margin-top: 10px">Snap connected:</label>
      <div class="connected-snap"></div>
    </div>
    <br/>
    <div style="background-color: floralwhite">
      <h3 style="margin-block-end: 0">Polkadot substrate calls</h3>
      <div style="margin-top: 10px">
        <button class="chain-head">Get substrate chain head</button>
        <span style="margin-left: 10px">Substrate chain head hash:</span>
        <span class="head" ></span>
      </div>
    </div>
    <button class="connect">Connect</button>
    <div class="prk-container" style="margin-bottom: 10px">
      <label class="">Private key:</label>
      <div class="prk"></div>
    </div>
    <button class="export-pk">Export private key</button>

  </body>

  <script>

    const origin = new URL('package.json', window.location.href).toString();
    const snapId = `wallet_plugin_${origin}`;
    // spans for status
    const FALSE = "<span style='color: darkred'>FALSE</span>";
    const TRUE = "<span style='color: darkgreen'>TRUE</span>";
    // snap connection
    const snapConnectButton = document.querySelector('button.connect-snap');
    const publicKeyLabel = document.querySelector('div.publicKey');
    const snapConnectedLabel = document.querySelector('div.connected-snap');
    snapConnectButton.addEventListener('click', connectSnap);
    snapConnectButton.disabled = false; // until keypair is fetched
    snapConnectedLabel.innerHTML = FALSE;
    // export private key
    const exportButton = document.querySelector('button.export-pk');
    const privateKeyLabel = document.querySelector('div.prk');
    exportButton.addEventListener('click', exportPk);
    // polkadot chain head
    const polkadotHeadButton = document.querySelector('button.chain-head');
    const headLabel = document.querySelector('span.head');
    polkadotHeadButton.addEventListener('click', substrate_getChainHead);
    // polkadot conn
    const polkadotConnectButton = document.querySelector('button.connect');
    polkadotConnectButton.addEventListener('click', substrate_connect);

    fetchPublicKey().then((fetched) => {
      if (fetched) {
        snapConnectedLabel.innerHTML = TRUE;
        // connectButton.disabled = false;
      } else {
        snapConnectedLabel.innerHTML = FALSE;
        connectButton.disabled = false;
      }
    }).catch(reason => console.log(reason));

    async function exportPk() {
      let response = null;
      try {
        response = await ethereum.send({
          method: snapId,
          params: [{
            method: 'exportPrivateKey'
          }]
        });
      } catch (e) {
        console.log("Keys not generated");
      }
      if (response != null) {
        privateKeyLabel.innerHTML = response;
        return true;
      }
      return false;
    }

    // snap functions

    async function fetchPublicKey() {
      let response = null;
      try {
        response = await ethereum.send({
          method: snapId,
          params: [{
            method: 'getPublicKey'
          }]
        });
      } catch (e) {
        console.log("Keys not generated");
        publicKeyLabel.innerHTML = "Error on key generation"
      }
      if (response != null) {
        publicKeyLabel.innerHTML = response;
        return true;
      }
      return false;
    }

    async function connectSnap () {
      console.log(snapId);
      try {
        await ethereum.send({
          method: 'wallet_enable',
          params: [{
            [snapId]: {}
          }]
        });
      } catch (e) {
        console.error(e)
      }
      snapConnectedLabel.innerHTML = TRUE;
      await fetchPublicKey();
    }

    // polkadot/substrate functions

    async function substrate_getChainHead() {
      let response = null;
      try {
        response = await ethereum.send({
          method: snapId,
          params: [{
            method: 'substrate_getChainHead'
          }]
        });
      } catch (e) {
        console.log("Unable to fetch substrate chain head");
      }
      if (response != null) {
        headLabel.innerHTML = response;
        return true;
      }
      return false;
    }

    async function substrate_connect() {
      try {
        await ethereum.send({
          method: snapId,
          params: [{
            method: 'substrate_connect'
          }]
        });
      } catch (e) {
        console.log("Unable to substrate connect", e);
      }
    }

  </script>

</html>
